---
layout: post
title: 'Exchange 2013: работа служб Store, FAST, и ESE Cache'
date: '2013-11-19T18:26:00.003+04:00'
author: Михаил Даньшин
tags:
- Exchange 2013
- Microsoft
- PowerShell
- Интересные факты
- Exсhange
modified_time: '2013-11-19T18:30:33.100+04:00'
thumbnail: http://lh5.ggpht.com/-0Vla3RnpCiI/Uot0hQUcHlI/AAAAAAAABmw/qc9tcsh5QSQ/s72-c/clip_image002_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-4356865488511124854.post-4713783571353306972
blogger_orig_url: https://www.danshin.ms/2013/11/exchange-2013-store-fast-ese-cache.html
---

<h5>После того как я получил много отзывов на свой пост «<a href="http://blogs.technet.com/b/rischwen/archive/2013/03/13/exchange-2013-mail-flow-demystified-hopefully.aspx">Exchange 2013 Mail flow Demystified</a>» я решил похожим же образом осветить работу таких компонентов как Store, FAST, и ESE Cache. В Exchange 2013 многое изменилось в работе хранилища (store). Я надеюсь, что смогу пролить свет на эти изменения. Давайте начнем прежде всего с работы хранилища, т.к. это является основой вашей почты.</h5>В Exchange 2013 Store.exe (который не менялся с Exchange 4.0) получил столь необходимые, капитальные изменения, и был полностью переписан в управляемом коде C#. Процесс store.exe теперь разбит на 2 процесса: Microsoft.Exchange.Store.Service.exe и Microsoft.Exchange.Store.Worker.exe. Процесс Store.Service отвечает за управление и завершение всех процессов Store.Worker. Каждая база данных на сервере почтовых ящиков имеет собственный процесс Store.Worker независимо от того активная это или пассивная копия базы данных. На изображении ниже Вы можете видеть оба процесса, и как база данных WorkerProcessID (PID) коррелирует с процессом Store.Worker. Разделение работы хранилища на несколько процессов сводит к минимуму шансы обрушить весь store.exe и остановить все базы данных на сервере. <br /><br /><a href="http://lh5.ggpht.com/-_IU0J1cKyEY/Uot0gtSzC4I/AAAAAAAABms/CJVeBLnwSgo/s1600-h/clip_image002%25255B4%25255D.png"><img alt="clip_image002" border="0" height="103" src="http://lh5.ggpht.com/-0Vla3RnpCiI/Uot0hQUcHlI/AAAAAAAABmw/qc9tcsh5QSQ/clip_image002_thumb%25255B1%25255D.png?imgmax=800" style="border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline;" title="clip_image002" width="484" /></a> <br /><br />Каждый, кто работал с Exchange 2010 и старше знает, что процесс Store.exe забирает большинство памяти сервера (75-90%). Это штатное поведение (by design). ESE (store.exe) высвободит памяти, если она понадобится другим процессам. Вы также можете установить ключ реестра msExchESEParamCacheSizeMax и указать максимальный объем памяти, который ESE может потреблять на этом сервере. Эта конструкция отлично подходит для Exchange 2010 и предыдущих версий. Но в Ezxchange Exchange 2013 архитектура сильно изменилась. <br />В связи с тем, что Exchange 2013 требуется больше памяти для других процессов, таких как Поиск (FAST) и Транспорта (Transport), мы должны были ограничить объем оперативной памяти, который использовал ESE. Теперь, в Exchange 2013, ESE (Store) будет использовать 25% от общего объема оперативной памяти. Так что если ваш сервер имеет 48 Гб памяти ESE будет использовать 12 Гб для кэша. Эти 12GB будут использоваться для поддержания работы всех баз данных. Прежде чем вдаваться в точное описание скажу, что ESE будет использовать около 80% от 12 ГБ для активных копий и 20% для пассивных копий баз данных. Достаточно просто не так ли? Но не все так просто! Проблема может возникнуть, если вы неправильно установите MaximumActiveDatabases на сервере почтовых ящиков (Set-Mailbox -MaximumActiveDatabases). Давайте рассмотрим два примера, и вы увидите, что я имею ввиду. <br /><br /><b>Пример 1</b> – На нашем MBX сервере установлено 48 GB памяти и располагается 8 баз данных (4 активные и 4 пассивные). В этом примере мы не устанавливали значение параметра MaximumActiveDatabases на сервере MBX. В таком случае, Вы можете наблюдать, что из выделенных 12GB для ESE, используется только 7.2GB. <br /><br />Общий объем RAM = 48GB<br />48GB*25%=12GB выделено для кэша ESE<br />4 активные копии на сервере <br />4 пассивные копии на сервере (потенциально они могут стать активными)<br />12GB/(4+4) = 1.5GB<br />Кэш активных БД = 1.5GB<br />Кэш пассивных БД =1.5GB*0.20 = 0.3GB<br /><span style="background-color: yellow;"><b>Макс. Объем для активных и пассивных БД = 12</b><b>GB</b><b> (25% </b><b>RAM</b><b>)</b><br /><b>Использование кэша = (4*1.5</b><b>GB</b><b> + 4* 0.3</b><b>GB</b><b> = 7.2</b><b>GB</b><b>)</b></span> <br /><b><br /></b>Пример 2 - Наш MBX сервер имеет те же 48 ГБ памяти и по-прежнему насчитывается 8 баз данных (4 активных и 4 пассивных). На этот раз мы устанавливаем значение параметра MaximumActiveDatabase на сервере MBX равное 4. Теперь вы можете видеть, что в типичном сценарии мы используем 12 ГБ (100%) из выделенных кэшу. <br /><br />Общий объем RAM = 48GB<br />MaximumActiveDatabases = 4<br />48GB*25%=12GB выделено для кэша ESE<br />4 активные копии на сервере <br />4 пассивные копии на сервере (они не смогут стать активными т.к. максимальное значение 4)<br />12GB/(4+4*.20) = 2.5GB<br />Кэш активных БД = 2.5GB<br />Кэш пассивных БД =2.5GB*0.20 = 0.5GB<br /><span style="background-color: yellow;"><b>Макс. Объем для активных и пассивных БД = 12</b><b>GB</b><b> (25% </b><b>RAM</b><b>)</b><br /><b>Использование кэша = (4*2.5</b><b>GB</b><b> + 4* 0.5</b><b>GB</b><b> = 12</b><b>GB</b><b>)</b></span> <br /><b><br /></b>Вы наглядно убедились в том, как установка значения MaximumActiveDatabase оказывает влияние на Вашу среду. Если стандартный пользователь использует 5 МБ кэша ESE, то разница составляет примерно в 204 (плюс/минус) почтовых ящика, в активной базе данных. Правильная настройка = Оптимальная производительность! <br /><br />В заключение, я хочу рассказать о новой поисковой платформе, которую использует Exchange - FAST. Многие уже знакомы с системой быстрого поиска FAST, поскольку она используется в SharePoint. Я не буду углубляться в детали, а сосредоточусь на описании процессов и требованиях к памяти на MBX сервере. Сервис Microsoft Exchange Search запускает процесс, который называется hostcontrollerservice.exe. Host Controller, в свою очередь, запускает 4 процесса под названием noderunner.exe. Вы можете увидеть их ниже, на снимке экрана. Каждый из этих процессов отвечает за свою часть поисковой инфраструктуры – Контент, Запросы, Индексы и Администрирование (Content, Query, Index, and Admin). Обратите внимание на то, что эти процессы занимают значительный объем памяти. Лучшей практикой является выделение 15%, от общего объема памяти, на все процессы Поисковой Инфраструктуры (Search Infrastructure). В приведенных выше примерах это означало бы, что для поиска нужно использовать 7.2GB. <br /><br /><a href="http://lh4.ggpht.com/-h4iJ46gcnUE/Uot0hyWBrzI/AAAAAAAABm4/IkU5ovIe0X0/s1600-h/clip_image004%25255B4%25255D.png"><img alt="clip_image004" border="0" height="125" src="http://lh5.ggpht.com/-M2Lqj7Mis7s/Uot0iPlBM_I/AAAAAAAABnA/E4gJL5vKk_c/clip_image004_thumb%25255B1%25255D.png?imgmax=800" style="border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline;" title="clip_image004" width="484" /></a> <br /><br />Автор статьи: Richard Schwendiman<br /><br />Оригинал статьи на англ. языке находится по следующей ссылке: - <a href="http://blogs.technet.com/b/rischwen/archive/2013/07/29/exchange-2013-store-fast-and-ese-cache-demystified-hopefully.aspx%EF%BF%BC">http://blogs.technet.com/b/rischwen/archive/2013/07/29/exchange-2013-store-fast-and-ese-cache-demystified-hopefully.aspx</a> <br /><br />Перевел статью:<br />Даньшин Михаил Сергеевич <br />Блог – <a href="http://danshin.ms/">http://danshin.ms</a><br />Facebook - <a href="https://www.facebook.com/Danshin.ms">https://www.facebook.com/Danshin.ms</a><br />E-Mail: - <a href="mailto:mdanshin@gmail.com">mdanshin@gmail.com</a><br /><br /><br /><iframe allowtransparency="true" frameborder="0" scrolling="no" src="//www.facebook.com/plugins/follow?href=https%3A%2F%2Fwww.facebook.com%2Fmdanshin&amp;layout=standard&amp;show_faces=true&amp;colorscheme=light&amp;width=450&amp;height=80" style="border: none; height: 80px; overflow: hidden; width: 450px;"></iframe>